(Done for D4. D3 on another branch)
